# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Go REST API backend generated by [Autostrada](https://autostrada.dev/). It provides a JSON API with:
- **Go 1.24** runtime
- **SQLite3** database with `mattn/go-sqlite3` driver and `jmoiron/sqlx` extensions
- **Leveled logging** using `slog` and `tint` packages
- **Manifest Version 3** extension integration (serves Chrome extension side panel)

## Development Commands

```bash
# Install/update dependencies and format code
make tidy

# Run application (build + execute)
make run

# Run with live reload (auto-rebuild on file changes)
make run/live

# Build binary only (outputs to /tmp/bin/api)
make build

# Run all tests
make test

# Run tests with HTML coverage report
make test/cover

# Quality control (format, vet, staticcheck, vuln check)
make audit

# Direct execution (without Makefile)
go run ./cmd/api

# Build and run with custom flags
go run ./cmd/api --http-port=9999 --db-dsn="custom.db"
```

## Configuration

All configuration is managed via command-line flags in `cmd/api/main.go`:

- `--base-url` - Base URL for the application (default: `http://localhost:3233`)
- `--http-port` - HTTP server port (default: `3233`)
- `--basic-auth-username` - Basic auth username (default: `admin`)
- `--basic-auth-hashed-password` - Bcrypt-hashed password
- `--db-dsn` - SQLite database path (default: `db.sqlite?_foreign_keys=on`)
- `--version` - Display version and exit

## Architecture

### Application Structure

Standard Go HTTP server architecture with dependency injection via the `application` struct:

- **`cmd/api/main.go`** - Entry point, config parsing, dependency initialization
- **`cmd/api/server.go`** - HTTP server lifecycle and graceful shutdown
- **`cmd/api/routes.go`** - Route mappings and middleware chain
- **`cmd/api/handlers.go`** - HTTP request handlers
- **`cmd/api/middleware.go`** - HTTP middleware (auth, logging, panic recovery)
- **`cmd/api/helpers.go`** - Shared helper functions and background task runner
- **`cmd/api/errors.go`** - Error response helpers

### Internal Packages

```
internal/
├── database/     # Database setup, connection, and query methods
├── request/      # JSON decoding utilities (DecodeJSON, DecodeJSONStrict)
├── response/     # JSON encoding utilities (JSON, JSONWithHeaders)
├── validator/    # Validation helpers and Validator type
└── version/      # Version info from VCS (Get, GetRevision)
```

### Handler Pattern

All handlers are methods on `*application` to access dependencies:

```go
func (app *application) handlerName(w http.ResponseWriter, r *http.Request) {
    // Access app.db, app.logger, app.config
}
```

### Database Access

- SQLite database accessed via `app.db` (type `*database.DB`)
- Supports both standard `Exec/Query/QueryRow` and sqlx extensions
- Database methods should be defined in `internal/database/` package
- Foreign keys are enabled via DSN parameter `?_foreign_keys=on`

### Validation Pattern

Use the `validator.Validator` type embedded in request structs:

```go
var input struct {
    Name      string              `json:"name"`
    Validator validator.Validator `json:"-"`
}
input.Validator.CheckField(input.Name != "", "name", "Name is required")
if input.Validator.HasErrors() {
    app.failedValidation(w, r, input.Validator)
    return
}
```

## Key Features

### Live Reload

The `make run/live` command uses [cosmtrek/air](https://github.com/cosmtrek/air) to watch for changes in:
- `.go`, `.tpl`, `.tmpl`, `.html`
- `.css`, `.scss`, `.js`, `.ts`, `.sql`
- Image files (`.jpeg`, `.jpg`, `.gif`, `.png`, `.bmp`, `.svg`, `.webp`, `.ico`)

### Background Tasks

Use `app.backgroundTask(r, func() error {...})` to run goroutines that:
- Automatically recover from panics
- Are tracked for graceful shutdown
- Log errors appropriately

### Basic Authentication

Middleware available via `app.requireBasicAuthentication(handler)`. Test credentials:
- Username: `admin`
- Password: `pa55word`

Generate new bcrypt password hashes:
```bash
go run gophers.dev/cmds/bcrypt-tool@latest hash 'your_password'
```

### Logging

Structured logging via `app.logger` (type `*slog.Logger`):
- Default level: `Debug`
- Output: `os.Stdout` with tint formatting
- HTTP server logs are at `Warn` level

## Module Path

Current module: `dev.danielrb/auto-imm/api`

To change, find and replace all instances of `dev.danielrb/auto-imm/api` in the codebase.

## Testing

- Run tests: `make test` (includes race detector and build VCS info)
- Coverage: `make test/cover` (opens HTML report in browser)
- Tests should be placed alongside the code they test (e.g., `handlers_test.go`)
